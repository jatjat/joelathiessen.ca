services:
  - docker:dind

stages:
  - build
  - release
  - staging
  - production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: "tcp://localhost:2375"

before_script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY

build:
  stage: build
  image: docker:stable
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE:$CI_BUILD_REF .
    - docker push $CI_REGISTRY_IMAGE:$CI_BUILD_REF
  except:
    - tags

release-name:
  stage: release
  image: docker:stable
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_BUILD_REF
    - docker tag $CI_REGISTRY_IMAGE:$CI_BUILD_REF $CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME
    - docker push $CI_REGISTRY_IMAGE:$CI_BUILD_REF
  except:
    - master

release-master:
  stage: release
  image: docker:stable
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_BUILD_REF
    - docker tag $CI_REGISTRY_IMAGE:$CI_BUILD_REF $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - master

.common-deploy-script: &common-deploy-script
  script:
    # Rollback enabled:
    - echo "$CI_REGISTRY_IMAGE"
    - echo "$CI_BUILD_REF"
    - sed -i "s|__IMAGE_NAME__|$CI_REGISTRY_IMAGE:$CI_BUILD_REF|" deployment.yml
    - sed -i "s|__JOEL_DEPLOYMENT_NAME__|$JOEL_DEPLOYMENT_NAME|" deployment.yml
    - sed -i "s|__JOEL_CONTAINER_NAME__|$JOEL_CONTAINER_NAME|" deployment.yml
    - sed -i "s|__JOEL_APP_LABEL__|$JOEL_APP_LABEL|" deployment.yml service.yml
    - sed -i "s|__KALY2_SERVICE_NAME__|$KALY2_SERVICE_NAME|" deployment.yml service.yml
    - sed -i "s|__JOEL_SERVICE_NAME__|$JOEL_SERVICE_NAME|" service.yml
    - |
      #SESSION_SECRET=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1);
      #sed -i "s|__SES_SECRET__|$SESSION_SECRET|" deployment.yml
    - kubectl apply -f service.yml
    - |
      if kubectl apply -f deployment.yml | grep -q unchanged; then
        echo "Forcing image update by patching deployment"
        kubectl patch -f deployment.yml -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-last-updated\":\"$(date +'%s')\"}}}}}"
      else
        echo "Applying deployment caused succesful image update"
      fi

deploy-staging:
  stage: staging
  image: registry.joelathiessen.ca/kaly2/joelathiessen.ca/jbuild
  variables:
    JOEL_SERVICE_NAME: "joel-service-staging"
    JOEL_DEPLOYMENT_NAME: "joel-deployment-staging"
    JOEL_CONTAINER_NAME: "joel-container-staging"
    JOEL_APP_LABEL: "joel-frontend-staging"
    KALY2_SERVICE_NAME: "kaly2-staging.kaly2.svc.cluster.local"
  <<: *common-deploy-script
  environment:
    name: staging
    url: https://staging.home.joelathiessen.ca
  except:
    - master

deploy-production:
  stage: production
  image: registry.joelathiessen.ca/kaly2/joelathiessen.ca/jbuild
  variables:
    JOEL_SERVICE_NAME: "joel-service-prod"
    JOEL_DEPLOYMENT_NAME: "joel-deployment-prod"
    JOEL_CONTAINER_NAME: "joel-container-prod"
    JOEL_APP_LABEL: "joel-frontend-prod"
    KALY2_SERVICE_NAME: "kaly2-prod.kaly2.svc.cluster.local"
  <<: *common-deploy-script
  environment:
    name: production
    url: https://prod.home.joelathiessen.ca
  only:
    - master
